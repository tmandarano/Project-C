<!DOCTYPE html>
<head> 
  <title>Upload LG</title> 
  <style type="text/css">
    * { font-family: sans-serif; }
  </style>
</head> 
<body> 
  <form action="" method="POST" enctype="multipart/form-data">
  <table>
    <tr>
      <th><label for="photo_image">Photo</label></th>
      <td><input id="photo_image" name="image" type="file" /></td>
      <td id="preview" style="height: 200px;"></td>
    </tr>
    <tr>
      <th><label for="caption">Caption</label></th>
      <td><input id="caption" name="caption" type="text" /></td>
    </tr>
  </table>
  <input id="photo_submit" type="submit" value="Share" />
  </form>

  <iframe scrolling="no" frameBorder="no" allowtransparency="true" style="width:400px;height:160px"></iframe>

  <script type="text/javascript" src="http://code.jquery.com/jquery-1.4.4.min.js"></script>
  <script type="text/javascript" src="http://github.com/malsup/form/raw/master/jquery.form.js?v2.43"></script>
  <script type="text/javascript">
$(function () {
  $('iframe').attr('src',
    'http://livegather.rpxnow.com/openid/embed?token_url=' +
    encodeURIComponent(window.location.protocol + '//' +
                       window.location.host) + '/rpx').hide();
  $.ajax({
    url: window.location.protocol + '//' + window.location.host + '/users',
    success: function (user) {
      $('iframe').replaceWith('<p>' + user.toString() + '</p');
    },
    error: function () {
      $('iframe').show();
    }
  });
  $(':file').change(function () {
    if (FileList && FileReader) {
      var file = this.files[0];
      if (file) {
        var r = new FileReader();
        r.onload = function (e) {
          $('#preview').html('<img style="height: 200px;" src="' + e.target.result + '" />');
        };
        r.readAsDataURL(file);
      }
    }
  });
  $(':submit').click(function () {
    var okay = false;
    $.ajax({
      async: false,
      url: 'http://' + window.location.host + '/photos/upload',
      success: function (url) {
        if (url) {
          $('form').attr('action', url).css('background', '#afa');
          console.log(url);
          okay = true;
        }
      }
    });
    return okay;
  });

  $('#caption').val('caption yay');
});
  </script>
</body> 
